<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Paper Valuation System</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">

        <!-- Header -->
        <header class="header">
            <div>
                <h1>Welcome, <%= user.full_name || user.username %>! üëã</h1>
                <p>Paper Valuation System Dashboard</p>
            </div>
            <div class="header-actions">
                <a href="/profile" class="btn btn-primary">üë§ Profile</a>
                <a href="/history" class="btn btn-secondary">üìä History</a>
                <form action="/logout" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">üö™ Logout</button>
                </form>
            </div>
        </header>

        <!-- Statistics -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-value" id="totalExams">-</div>
                <div class="stat-label">Total Exams Created</div>
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="section">
            <h2>Quick Actions</h2>
            <div class="actions-grid">
                <a href="/answer-key-setup" class="action-card">
                    <span class="action-icon">üîë</span>
                    <span class="action-label">Create Answer Key</span>
                </a>
                <a href="/upload-individual" class="action-card">
                    <span class="action-icon">üìÑ</span>
                    <span class="action-label">Individual Evaluation</span>
                </a>
                <a href="/upload-series" class="action-card">
                    <span class="action-icon">üì¶</span>
                    <span class="action-label">Batch Evaluation</span>
                </a>
                <a href="/history" class="action-card">
                    <span class="action-icon">üìä</span>
                    <span class="action-label">View History</span>
                </a>
            </div>
        </section>

        <!-- Recent Activity -->
        <section class="section">
            <h2>Recent Activity</h2>
            <ul class="activity-list" id="activityList">
                <li class="loading">Loading recent activity...</li>
            </ul>
        </section>

    </div>

    <script>
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/dashboard/stats');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                if (data.status === 'Success') {
                    document.getElementById('totalExams').textContent = data.stats.total_exams || 0;
                    displayRecentActivity(data.recent_activity);
                } else {
                    throw new Error(data.error || 'Failed to load stats');
                }
            } catch (error) {
                console.error('Dashboard error:', error);
                showError();
            }
        }

        function displayRecentActivity(activities) {
            const list = document.getElementById('activityList');
            if (!activities || activities.length === 0) {
                list.innerHTML = `
                    <li class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div class="empty-text">No recent activity</div>
                        <div class="empty-subtext">Start by creating an answer key or uploading papers!</div>
                    </li>`;
                return;
            }
            list.innerHTML = activities.map(a => `
                <li class="activity-item">
                    <div class="activity-content">
                        <div class="activity-title">${escapeHtml(a.title)}</div>
                        <div class="activity-details">${escapeHtml(a.details)}</div>
                    </div>
                    <div class="activity-date">${escapeHtml(a.date)}</div>
                </li>`).join('');
        }

        function showError() {
            document.getElementById('activityList').innerHTML = `
                <li class="empty-state">
                    <div class="empty-icon">‚ö†Ô∏è</div>
                    <div class="empty-text">Failed to load dashboard</div>
                    <div class="empty-subtext">Please refresh the page to try again</div>
                </li>`;
            document.getElementById('totalExams').textContent = '?';
        }

        function escapeHtml(text) {
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadDashboardStats);
        } else {
            loadDashboardStats();
        }
    </script>
</body>
</html>
