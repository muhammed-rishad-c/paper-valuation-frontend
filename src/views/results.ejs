<%- include('partials/head', { pageTitle: title || 'Result' }) %>

<%- include('partials/navbar', { user: user, activePage: 'upload' }) %>

<main class="page-content">
    <div class="container" style="max-width:860px;">

        <% if (result.exam_info) { %>
        <div style="background:var(--slate-50); border:1px solid var(--color-border); border-radius:var(--r); padding:0.6rem 1rem; margin-bottom:1.25rem; font-size:0.825rem; color:var(--color-text-2);">
            üìã <strong><%= result.exam_info.exam_name %></strong> &nbsp;‚Ä¢&nbsp;
            <%= result.exam_info.class %> &nbsp;‚Ä¢&nbsp; <%= result.exam_info.subject %>
        </div>
        <% } %>

        <% if (result.status === 'Success' && result.evaluation_result) { %>

            <!-- Score Summary -->
            <div class="score-summary">
                <h2>‚úÖ Evaluation Complete!</h2>
                <div class="score-grid">
                    <div class="score-item">
                        <span class="score-label">Marks Obtained</span>
                        <div class="score-value"><%= result.evaluation_result.total_marks_obtained %></div>
                    </div>
                    <div class="score-item">
                        <span class="score-label">Total Marks</span>
                        <div class="score-value"><%= result.evaluation_result.total_marks_possible %></div>
                    </div>
                    <div class="score-item">
                        <span class="score-label">Percentage</span>
                        <div class="score-value"><%= result.evaluation_result.percentage %>%</div>
                    </div>
                </div>
                <div style="text-align:center;">
                    <span class="result-badge <%= result.evaluation_result.result === 'Pass' ? 'result-pass' : 'result-fail' %>">
                        <%= result.evaluation_result.result === 'Pass' ? '‚úì Pass' : '‚úó Fail' %>
                    </span>
                </div>
            </div>

            <!-- Question-wise Breakdown -->
            <div class="section">
                <h2 class="section-title">üìù Question-wise Breakdown</h2>

                <%
                const marksBreakdown = result.evaluation_result.marks_breakdown;
                const questionLabels = Object.keys(marksBreakdown).sort((a, b) => {
                    return parseInt(a.replace(/\D/g,'')) - parseInt(b.replace(/\D/g,''));
                });
                %>

                <% questionLabels.forEach(qLabel => {
                    const q = marksBreakdown[qLabel];
                    const scorePercentage = (q.marks_obtained / q.max_marks) * 100;
                    let progressClass = 'progress-poor';
                    if (scorePercentage >= 70) progressClass = 'progress-excellent';
                    else if (scorePercentage >= 40) progressClass = 'progress-good';
                    const isOrGroup = q.or_group;
                %>
                    <div class="question-card <%= isOrGroup ? 'or-group-card' : '' %>">
                        <div class="question-header">
                            <div>
                                <span class="question-label"><%= qLabel %></span>
                                <span class="question-type"><%= q.question_type %></span>
                                <% if (isOrGroup) { %><span class="or-badge">‚ö° OR Question</span><% } %>
                            </div>
                            <div class="marks-display">
                                <span class="marks-obtained"><%= q.marks_obtained %></span> / <%= q.max_marks %>
                            </div>
                        </div>

                        <% if (isOrGroup) { %>
                        <div class="or-details">
                            <% if (q.or_type === 'single') { %>
                                Options: Q<%= q.or_options[0] %> OR Q<%= q.or_options[1] %>
                                ‚Üí <strong>Best score from Q<%= q.chosen_option %></strong>
                            <% } else if (q.or_type === 'pair') { %>
                                Options: Q<%= q.or_pair_a.join(',') %> OR Q<%= q.or_pair_b.join(',') %>
                                ‚Üí <strong>Best score from Pair <%= q.chosen_pair.toUpperCase() %></strong>
                            <% } %>
                        </div>
                        <% } %>

                        <div class="progress-bar-container">
                            <div class="progress-bar <%= progressClass %>" style="width:<%= scorePercentage %>%;"></div>
                        </div>

                        <% if (result.recognition_result && result.recognition_result.answers && result.recognition_result.answers[qLabel]) { %>
                        <details style="margin-top:0.75rem;">
                            <summary style="cursor:pointer; font-size:0.875rem; font-weight:600; color:var(--color-text-2); padding:0.4rem 0.75rem; background:var(--slate-50); border-radius:var(--r-sm); user-select:none;">
                                View Answer Text
                            </summary>
                            <div class="answer-text">
                                <pre><%= result.recognition_result.answers[qLabel] %></pre>
                            </div>
                        </details>
                        <% } %>
                    </div>
                <% }); %>
            </div>

        <% } else { %>
            <!-- Recognition only (no exam selected) -->
            <div class="recognition-section">
                <h2 class="section-title">üìÑ Extracted Text (Recognition Only)</h2>
                <p style="font-size:0.875rem; color:var(--color-text-2); margin-bottom:1.25rem;">
                    ‚ÑπÔ∏è This paper was processed for text extraction only. Select an exam next time for full marks evaluation.
                </p>
                <% if (result.recognition_result && result.recognition_result.answers) { %>
                    <% Object.entries(result.recognition_result.answers).forEach(([qLabel, text]) => { %>
                        <div class="question-card" style="border-left:3px solid var(--color-primary);">
                            <div class="question-header">
                                <span class="question-label"><%= qLabel %></span>
                            </div>
                            <div class="answer-text"><pre><%= text %></pre></div>
                        </div>
                    <% }); %>
                <% } %>
            </div>
        <% } %>

        <!-- Raw extraction (collapsed) -->
        <% if (result.recognition_result) { %>
        <div class="recognition-section">
            <details>
                <summary>üîç View Raw Extraction Details</summary>
                <pre style="margin-top:0.75rem; background:var(--slate-50); border:1px solid var(--color-border); border-radius:var(--r); padding:1rem; font-size:0.8rem; overflow-x:auto;"><%= JSON.stringify(result.recognition_result, null, 2) %></pre>
            </details>
        </div>
        <% } %>

        <!-- Actions -->
        <div class="action-buttons">
            <a href="/upload-individual" class="btn btn-primary">üìÑ Evaluate Another Paper</a>
            <a href="/" class="btn btn-secondary">üè† Back to Dashboard</a>
        </div>

    </div>
</main>

<%- include('partials/footer') %>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.progress-bar').forEach(bar => {
            const w = bar.style.width;
            bar.style.width = '0%';
            requestAnimationFrame(() => setTimeout(() => bar.style.width = w, 80));
        });
    });
</script>
