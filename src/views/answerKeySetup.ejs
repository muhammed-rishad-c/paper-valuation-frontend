<%- include('partials/head', { pageTitle: 'Answer Key Setup' }) %>

<%- include('partials/navbar', { user: user, activePage: 'answer-key' }) %>

<main class="page-content">
    <div class="container">

        <!-- Page Title -->
        <div class="header">
            <div>
                <h1>üîë Answer Key Setup</h1>
                <p>Configure your exam answer key in 3 easy steps</p>
            </div>
            <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">Exam Details</div>
            </div>
            <div class="progress-step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">Short Answers</div>
            </div>
            <div class="progress-step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">Long Answers</div>
            </div>
        </div>

        <!-- Step Content -->
        <div class="section content">

            <!-- STEP 1: Exam Metadata -->
            <div class="step-section active" id="step1">
                <h2>üìã Step 1: Exam Information</h2>

                <div class="info-box">
                    <strong>‚ÑπÔ∏è Instructions:</strong> Fill in the basic exam details and specify which questions are
                    short answers vs long answers with their marks.
                </div>

                <form id="metadata-form">
                    <div class="form-group">
                        <label for="exam-name">Exam Name *</label>
                        <input type="text" id="exam-name" name="exam_name"
                            placeholder="e.g., Mathematics Mid-Term 2025" required>
                        <small>Give this answer key a unique, descriptive name</small>
                    </div>

                    <div class="form-group">
                        <label for="class-name">Class *</label>
                        <input type="text" id="class-name" name="class_name" placeholder="e.g., S5" required>
                    </div>

                    <div class="form-group">
                        <label for="subject">Subject *</label>
                        <input type="text" id="subject" name="subject" placeholder="e.g., Mathematics" required>
                    </div>

                    <div class="form-group">
                        <label for="short-questions">Short Answer Questions *</label>
                        <input type="text" id="short-questions" name="short_questions"
                            placeholder="e.g., 1-10 or 1,2,3,4,5" required>
                        <small>Use ranges (1-10) or comma-separated (1,2,3).</small>
                    </div>

                    <div class="form-group">
                        <label for="short-marks">Marks for Short Questions *</label>
                        <input type="text" id="short-marks" name="short_marks" placeholder="e.g., 2 or 2,2,3" required>
                        <small>Single number for uniform marks or comma-separated for individual marks</small>
                        <div class="marks-example">
                            <strong>Examples:</strong><br>
                            ‚Ä¢ Questions 1-3, Marks "2" ‚Üí Q1=2, Q2=2, Q3=2<br>
                            ‚Ä¢ Questions 1-3, Marks "2,2,3" ‚Üí Q1=2, Q2=2, Q3=3
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="long-questions">Long Answer Questions *</label>
                        <input type="text" id="long-questions" name="long_questions"
                            placeholder="e.g., 11-20 or 11,12,13" required>
                        <small>Use ranges (11-20) or comma-separated (11,12,13).</small>
                    </div>

                    <div class="form-group">
                        <label for="long-marks">Marks for Long Questions *</label>
                        <input type="text" id="long-marks" name="long_marks" placeholder="e.g., 8 or 7,10,8" required>
                        <small>Single number for uniform marks or comma-separated for individual marks</small>
                        <div class="marks-example">
                            <strong>Examples:</strong><br>
                            ‚Ä¢ Questions 4-5, Marks "8" ‚Üí Q4=8, Q5=8<br>
                            ‚Ä¢ Questions 4-5, Marks "7,10" ‚Üí Q4=7, Q5=10
                        </div>
                    </div>

                    <!-- OR Questions Section -->
                    <div class="form-group" style="background:#fff3e0; padding:1.25rem; border-radius:var(--r-lg); border:2px solid #ffb74d; margin-top:1.5rem;">
                        <h3 style="margin-top:0; color:#e65100; margin-bottom:1rem;">‚ö° OR Questions Configuration <span style="font-size:0.8rem; font-weight:400; color:#bf360c;">(Optional)</span></h3>
                        <div class="warning-box" style="margin-bottom:1rem;">
                            <strong>üìå What are OR Questions?</strong><br>
                            Questions where students choose between options. System evaluates all written answers and takes the best score.<br><br>
                            <strong>Examples:</strong><br>
                            ‚Ä¢ <strong>Single:</strong> Q5 OR Q6 ‚Äî student writes one, best score counted<br>
                            ‚Ä¢ <strong>Pair:</strong> Q6,Q7 OR Q8,Q9 ‚Äî student writes one pair, best total counted
                        </div>

                        <div id="orGroupsContainer"></div>

                        <button type="button" class="btn btn-primary" onclick="addOrGroup()" style="margin-top:0.5rem;">
                            ‚ûï Add OR Group
                        </button>
                    </div>

                    <div class="button-group">
                        <a href="/" class="btn btn-secondary">‚Üê Back to Home</a>
                        <button type="button" class="btn btn-primary" onclick="goToStep2()">
                            Next: Upload Short Answers ‚Üí
                        </button>
                    </div>
                </form>
            </div>

            <!-- STEP 2: Short Answer Upload -->
            <div class="step-section" id="step2">
                <h2>üìù Step 2: Upload Short Answer Key</h2>

                <div class="info-box">
                    <strong>‚ÑπÔ∏è Instructions:</strong> Upload images of your short answer key pages.
                    The system will extract text in real-time for you to review and edit.
                </div>

                <div class="upload-area" id="short-upload-area"
                    onclick="document.getElementById('short-file-input').click()">
                    <div class="upload-icon">üì§</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-subtext">PNG, JPG up to 10MB</div>
                </div>
                <input type="file" id="short-file-input" accept="image/*" style="display:none;">

                <div class="extracted-answers" id="short-answers-container"></div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStep1()">‚Üê Back</button>
                    <button type="button" class="btn btn-primary" onclick="goToStep3()">
                        Next: Upload Long Answers ‚Üí
                    </button>
                </div>
            </div>

            <!-- STEP 3: Long Answer Upload -->
            <div class="step-section" id="step3">
                <h2>üìñ Step 3: Upload Long Answer Key</h2>

                <div class="info-box">
                    <strong>‚ÑπÔ∏è Instructions:</strong> Upload images of your long answer key pages.
                    These answers will preserve paragraph structure and formatting.
                </div>

                <div class="upload-area" id="long-upload-area"
                    onclick="document.getElementById('long-file-input').click()">
                    <div class="upload-icon">üì§</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-subtext">PNG, JPG up to 10MB</div>
                </div>
                <input type="file" id="long-file-input" accept="image/*" style="display:none;">

                <div class="extracted-answers" id="long-answers-container"></div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStep2()">‚Üê Back</button>
                    <button type="button" class="btn btn-success" onclick="saveAnswerKey()">
                        üíæ Save & Continue ‚Üí
                    </button>
                </div>
            </div>

        </div><!-- /.section.content -->
    </div><!-- /.container -->
</main>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h3>Processing...</h3>
        <p id="loading-message">Extracting text from image</p>
    </div>
</div>

<%- include('partials/footer') %>

<script>
    let currentStep = 1;
    let examMetadata = {};
    let shortAnswers = {};
    let longAnswers = {};

    function goToStep1() { showStep(1); }

    function goToStep2() {
        const form = document.getElementById('metadata-form');
        if (!form.checkValidity()) { form.reportValidity(); return; }

        const shortMarks = document.getElementById('short-marks').value.trim();
        const longMarks  = document.getElementById('long-marks').value.trim();

        if (!validateMarksFormat(shortMarks)) {
            showAlert('error', '‚ùå Invalid format for short question marks. Use single number (e.g., "2") or comma-separated (e.g., "2,2,3")');
            return;
        }
        if (!validateMarksFormat(longMarks)) {
            showAlert('error', '‚ùå Invalid format for long question marks. Use single number (e.g., "8") or comma-separated (e.g., "7,10")');
            return;
        }

        examMetadata = {
            exam_name:       document.getElementById('exam-name').value,
            class_name:      document.getElementById('class-name').value,
            subject:         document.getElementById('subject').value,
            short_questions: document.getElementById('short-questions').value,
            long_questions:  document.getElementById('long-questions').value,
            short_marks:     shortMarks,
            long_marks:      longMarks
        };

        showStep(2);
    }

    function validateMarksFormat(marksStr) {
        return /^\d+(\s*,\s*\d+)*$/.test(marksStr);
    }

    function goToStep3() { showStep(3); }

    function showStep(stepNumber) {
        document.querySelectorAll('.step-section').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + stepNumber).classList.add('active');

        document.querySelectorAll('.progress-step').forEach(step => {
            const n = parseInt(step.dataset.step);
            step.classList.remove('active', 'completed');
            if (n === stepNumber) step.classList.add('active');
            else if (n < stepNumber) step.classList.add('completed');
        });

        currentStep = stepNumber;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.getElementById('short-file-input').addEventListener('change', e => handleFileUpload(e.target.files[0], 'short'));
    document.getElementById('long-file-input').addEventListener('change',  e => handleFileUpload(e.target.files[0], 'long'));

    ['short-upload-area', 'long-upload-area'].forEach(areaId => {
        const area = document.getElementById(areaId);
        area.addEventListener('dragover',  e => { e.preventDefault(); area.classList.add('dragover'); });
        area.addEventListener('dragleave', ()  => area.classList.remove('dragover'));
        area.addEventListener('drop', e => {
            e.preventDefault();
            area.classList.remove('dragover');
            handleFileUpload(e.dataTransfer.files[0], areaId.includes('short') ? 'short' : 'long');
        });
    });

    async function handleFileUpload(file, answerType) {
        if (!file) return;
        const formData = new FormData();
        formData.append('answer_key_image', file);
        formData.append('answer_type', answerType);
        showLoading('Extracting text from image...');
        try {
            const response = await fetch('/api/extract-answer-key', { method: 'POST', body: formData });
            const result = await response.json();
            hideLoading();
            if (result.status === 'Success') {
                displayExtractedAnswers(result.answers, answerType);
                showAlert('success', '‚úÖ Successfully extracted ' + Object.keys(result.answers).length + ' answers!');
            } else {
                showAlert('error', '‚ùå Extraction failed: ' + result.error);
            }
        } catch (error) {
            hideLoading();
            showAlert('error', '‚ùå Upload failed: ' + error.message);
        }
    }

    function displayExtractedAnswers(answers, answerType) {
        const container = document.getElementById(answerType + '-answers-container');
        Object.entries(answers).forEach(([qLabel, answerText]) => {
            const item = document.createElement('div');
            item.className = 'answer-item';
            item.dataset.question = qLabel;
            item.dataset.type = answerType;
            item.innerHTML = `
                <div class="answer-header">
                    <span class="answer-label">${qLabel}</span>
                    <button class="delete-btn" onclick="deleteAnswer('${qLabel}', '${answerType}')">üóëÔ∏è Delete</button>
                </div>
                <textarea id="${answerType}-${qLabel}">${answerText}</textarea>`;
            container.appendChild(item);
            if (answerType === 'short') shortAnswers[qLabel] = answerText;
            else longAnswers[qLabel] = answerText;
        });
    }

    function deleteAnswer(qLabel, answerType) {
        const container = document.getElementById(answerType + '-answers-container');
        const item = container.querySelector('[data-question="' + qLabel + '"]');
        if (item && confirm('Delete ' + qLabel + '?')) {
            item.remove();
            if (answerType === 'short') delete shortAnswers[qLabel];
            else delete longAnswers[qLabel];
        }
    }

    async function saveAnswerKey() {
        document.querySelectorAll('#short-answers-container textarea').forEach(t => {
            shortAnswers[t.id.replace('short-', '')] = t.value;
        });
        document.querySelectorAll('#long-answers-container textarea').forEach(t => {
            longAnswers[t.id.replace('long-', '')] = t.value;
        });

        if (!Object.keys(shortAnswers).length && !Object.keys(longAnswers).length) {
            showAlert('error', '‚ùå Please upload at least one answer key page!');
            return;
        }

        const orGroups = collectOrGroups();
        if (orGroups.length > 0) {
            const v = validateOrGroups(orGroups);
            if (!v.valid) { showAlert('error', '‚ùå OR Group Error: ' + v.error); return; }
        }

        showLoading('Saving answer key...');

        try {
            const response = await fetch('/api/save-answer-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...examMetadata,
                    short_answers: shortAnswers,
                    long_answers: longAnswers,
                    or_groups: orGroups
                })
            });
            const result = await response.json();
            hideLoading();

            if (result.status === 'Success') {
                showAlert('success', '‚úÖ Answer key saved! Redirecting...');
                sessionStorage.setItem('latest_exam_id', result.exam_id);
                sessionStorage.setItem('exam_class', examMetadata.class_name);
                sessionStorage.setItem('exam_subject', examMetadata.subject);
                setTimeout(() => {
                    const toIndividual = sessionStorage.getItem('return_to_individual');
                    const toSeries     = sessionStorage.getItem('return_to_series');
                    window.location.href = toIndividual === 'true' ? '/upload-individual' : '/upload-series';
                }, 2000);
            } else {
                showAlert('error', '‚ùå Save failed: ' + result.error);
            }
        } catch (error) {
            hideLoading();
            showAlert('error', '‚ùå Network error: ' + error.message);
        }
    }

    function validateOrGroups(orGroups) {
        const seen = new Set();
        for (let i = 0; i < orGroups.length; i++) {
            const g = orGroups[i];
            const questions = g.type === 'single' ? g.options : [...g.option_a, ...g.option_b];
            if (g.type === 'single' && g.options[0] === g.options[1])
                return { valid: false, error: 'OR Group ' + (i+1) + ': Cannot have same question in both options' };
            for (let q of questions) {
                if (!/^\d+$/.test(q)) return { valid: false, error: 'OR Group ' + (i+1) + ': "' + q + '" is not a valid question number' };
                if (seen.has(q)) return { valid: false, error: 'Question ' + q + ' appears in multiple OR groups' };
                seen.add(q);
            }
        }
        return { valid: true };
    }

    function showLoading(message) {
        document.getElementById('loading-message').textContent = message;
        document.getElementById('loading-overlay').classList.add('active');
    }

    function hideLoading() {
        document.getElementById('loading-overlay').classList.remove('active');
    }

    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-' + type;
        alertDiv.textContent = message;
        const content = document.querySelector('.content');
        content.insertBefore(alertDiv, content.firstChild);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    // OR Groups
    let orGroupCounter = 0;

    function addOrGroup() {
        orGroupCounter++;
        const container = document.getElementById('orGroupsContainer');
        const div = document.createElement('div');
        div.id = 'orGroup_' + orGroupCounter;
        div.className = 'or-group-item';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem;">
                <div style="flex:1; margin-right:1rem;">
                    <label style="display:block; margin-bottom:0.4rem; font-size:0.875rem; font-weight:600;">OR Group Type:</label>
                    <select id="orType_${orGroupCounter}" class="or-type-select" onchange="updateOrGroupFields(${orGroupCounter})">
                        <option value="single">Single Question (e.g., Q5 OR Q6)</option>
                        <option value="pair">Question Pair (e.g., Q6,Q7 OR Q8,Q9)</option>
                    </select>
                </div>
                <button type="button" class="remove-or-btn" onclick="removeOrGroup(${orGroupCounter})">‚úñ Remove</button>
            </div>
            <div id="orGroupFields_${orGroupCounter}"></div>`;
        container.appendChild(div);
        updateOrGroupFields(orGroupCounter);
    }

    function updateOrGroupFields(groupId) {
        const type = document.getElementById('orType_' + groupId).value;
        const fields = document.getElementById('orGroupFields_' + groupId);
        if (type === 'single') {
            fields.innerHTML = `
                <div class="or-input-grid">
                    <div>
                        <label style="display:block; margin-bottom:0.4rem; font-size:0.825rem; font-weight:600;">Option A (Question Number):</label>
                        <input type="text" id="orSingleA_${groupId}" class="or-input-field" placeholder="5">
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:0.4rem; font-size:0.825rem; font-weight:600;">Option B (Question Number):</label>
                        <input type="text" id="orSingleB_${groupId}" class="or-input-field" placeholder="6">
                    </div>
                </div>
                <div class="or-hint">üí° Student answers Q5 OR Q6 ‚Äî system evaluates both and takes the best score.</div>`;
        } else {
            fields.innerHTML = `
                <div class="or-input-grid">
                    <div>
                        <label style="display:block; margin-bottom:0.4rem; font-size:0.825rem; font-weight:600;">Pair A (comma-separated):</label>
                        <input type="text" id="orPairA_${groupId}" class="or-input-field" placeholder="6,7">
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:0.4rem; font-size:0.825rem; font-weight:600;">Pair B (comma-separated):</label>
                        <input type="text" id="orPairB_${groupId}" class="or-input-field" placeholder="8,9">
                    </div>
                </div>
                <div class="or-hint">üí° Student answers Q6,Q7 OR Q8,Q9 ‚Äî system evaluates all and takes the best pair total.</div>`;
        }
    }

    function removeOrGroup(groupId) {
        const div = document.getElementById('orGroup_' + groupId);
        if (div && confirm('Remove this OR group?')) div.remove();
    }

    function collectOrGroups() {
        const groups = [];
        document.querySelectorAll('#orGroupsContainer .or-group-item').forEach(div => {
            const id   = div.id.split('_')[1];
            const type = document.getElementById('orType_' + id)?.value;
            if (type === 'single') {
                const a = document.getElementById('orSingleA_' + id)?.value.trim();
                const b = document.getElementById('orSingleB_' + id)?.value.trim();
                if (a && b) groups.push({ type: 'single', options: [a, b] });
            } else {
                const a = document.getElementById('orPairA_' + id)?.value.trim();
                const b = document.getElementById('orPairB_' + id)?.value.trim();
                if (a && b) groups.push({ type: 'pair', option_a: a.split(',').map(q => q.trim()), option_b: b.split(',').map(q => q.trim()) });
            }
        });
        return groups;
    }
</script>
