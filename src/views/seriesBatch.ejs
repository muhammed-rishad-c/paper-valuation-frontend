<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Bundle Valuation - Series Exam</title>
    <style>
        .container { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
        .global-header {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #90caf9;
        }
        .flex-row { display: flex; gap: 15px; margin-top: 10px; }
        .input-box {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
        }
        .student-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            background: #fff;
        }
        label { font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üë®‚Äçüè´ Series Exam Bundle Valuation</h1>

        <div class="global-header">
            <h3>üìù Exam General Details</h3>
            <div class="flex-row">
                <div style="flex: 1;">
                    <label>Batch Class (e.g., S8):</label>
                    <input type="text" id="globalClass" class="input-box" placeholder="S8" value="S8">
                </div>
                <div style="flex: 1;">
                    <label>Subject (e.g., AI):</label>
                    <input type="text" id="globalSubject" class="input-box" placeholder="AI" value="AI">
                </div>
            </div>
        </div>
        <!-- üÜï ADD THIS SECTION -->
<div class="global-header" style="background: #f3e5f5; border-color: #ba68c8;">
    <h3>üéØ Link to Existing Answer Key (Optional)</h3>
    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
        Select an exam to save student submissions for future valuation. 
        Leave blank if you just want to extract answers without saving.
    </p>
    <div>
        <label>Select Exam:</label>
        <select id="examIdSelect" class="input-box" style="cursor: pointer;">
            <option value="">-- No Exam (Just Extract Answers) --</option>
        </select>
    </div>
    <div id="examPreview" style="margin-top: 10px; padding: 10px; background: #fff; border-radius: 4px; display: none;">
        <strong>Selected Exam:</strong>
        <div id="examDetails" style="font-size: 0.85em; color: #555; margin-top: 5px;"></div>
    </div>
</div>

        <div id="studentContainer"></div>

        <div style="margin-top: 20px;">
            <button type="button" onclick="addStudentBlock()">‚ûï Add Student</button>
            <button type="button" id="submitBatchButton" onclick="submitBatchEvaluation()" style="display: none; background-color: #2e7d32; color: white; padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px;">üöÄ Start Batch Valuation</button>
        </div>

        <input type="file" id="globalFileInput" accept="image/*" multiple style="display: none;">

        <div id="loadingMessage" style="display: none; color: #1565c0; margin-top: 20px; font-weight: bold;">
            <p>Processing Bundle... Please stay on this page.</p>
        </div>
    </div>

    <script>
        let studentData = []; 
        let currentTargetStudentId = null;
        const globalFileInput = document.getElementById('globalFileInput');

        function addStudentBlock() {
            const studentId = Date.now();
            // We only need to store roll_no per student now
            studentData.push({ id: studentId, files: [], roll_no: "" });

            const container = document.getElementById('studentContainer');
            const card = document.createElement('div');
            card.id = `card-${studentId}`;
            card.className = "student-card";

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="width: 200px;">
                        <label>Student Roll No:</label>
                        <input type="text" class="input-box" placeholder="Enter Roll No" oninput="updateRollNo(${studentId}, this.value)">
                    </div>
                    <div>
                        <button type="button" onclick="triggerFileInput(${studentId})">üìÑ Add Pages</button>
                        <button type="button" onclick="removeStudent(${studentId})" style="color: #d32f2f; background: none; border: 1px solid #d32f2f; padding: 5px; cursor: pointer; border-radius: 3px;">Remove</button>
                    </div>
                </div>
                <div id="list-${studentId}" style="margin-top: 10px; font-size: 0.85em; color: #555;"></div>
            `;
            container.appendChild(card);
            updateSubmitBtn();
        }

        function updateRollNo(id, val) {
            const student = studentData.find(s => s.id === id);
            if (student) student.roll_no = val;
        }

        function triggerFileInput(id) {
            currentTargetStudentId = id;
            globalFileInput.click();
        }

        globalFileInput.addEventListener('change', function(e) {
            const newFiles = Array.from(e.target.files);
            if (newFiles.length > 0 && currentTargetStudentId) {
                const student = studentData.find(s => s.id === currentTargetStudentId);
                student.files = student.files.concat(newFiles);
                renderFileList(currentTargetStudentId);
            }
            globalFileInput.value = ''; 
        });

        function renderFileList(id) {
            const student = studentData.find(s => s.id === id);
            const listDiv = document.getElementById(`list-${id}`);
            listDiv.innerHTML = student.files.map((f, i) => 
                `<div>${i === 0 ? '<b>[ID]</b>' : '[Pg ' + i + ']'} ${f.name}</div>`
            ).join('');
            updateSubmitBtn();
        }

        function removeStudent(id) {
            studentData = studentData.filter(s => s.id !== id);
            document.getElementById(`card-${id}`).remove();
            updateSubmitBtn();
        }

        function updateSubmitBtn() {
            const btn = document.getElementById('submitBatchButton');
            btn.style.display = studentData.some(s => s.files.length > 0) ? 'inline-block' : 'none';
        }

        function submitBatchEvaluation() {
    document.getElementById('loadingMessage').style.display = 'block';
    const formData = new FormData();
    
    // Send Global Details
    formData.append('global_class', document.getElementById('globalClass').value);
    formData.append('global_subject', document.getElementById('globalSubject').value);
    
    // üÜï NEW: Include exam_id if selected
    const examId = document.getElementById('examIdSelect').value;
    if (examId) {
        formData.append('exam_id', examId);
        console.log(`üìã Submitting with Exam ID: ${examId}`);
    } else {
        console.log('‚ö†Ô∏è No exam selected - submissions will NOT be saved');
    }

    const activeStudents = studentData.filter(s => s.files.length > 0);
    formData.append('student_count', activeStudents.length);

    activeStudents.forEach((student, i) => {
        formData.append(`roll_no_${i}`, student.roll_no);
        
        student.files.forEach(file => {
            formData.append(`student_${i}`, file);
        });
    });

    fetch('/seriesBundleEvaluate', { method: 'POST', body: formData })
    .then(res => res.text())
    .then(html => {
        document.open();
        document.write(html);
        document.close();
    })
    .catch(err => {
        alert('Evaluation Failed: ' + err.message);
        document.getElementById('loadingMessage').style.display = 'none';
    });
}
        // üÜï NEW: Load available exams when page loads
async function loadAvailableExams() {
    try {
        const response = await fetch('/api/list_answer_keys');
        const data = await response.json();
        
        if (data.status === 'Success' && data.answer_keys.length > 0) {
            const select = document.getElementById('examIdSelect');
            
            data.answer_keys.forEach(exam => {
                const option = document.createElement('option');
                option.value = exam.exam_id;
                option.textContent = `${exam.exam_name} (${exam.class} - ${exam.subject})`;
                select.appendChild(option);
            });
            
            console.log(`‚úÖ Loaded ${data.answer_keys.length} available exams`);
        } else {
            console.log('‚ö†Ô∏è No answer keys found. Create one first in Answer Key Setup.');
        }
    } catch (error) {
        console.error('‚ùå Failed to load exams:', error);
    }
}

    // üÜï NEW: Show exam details when selected
    document.getElementById('examIdSelect').addEventListener('change', function() {
        const examId = this.value;
        const preview = document.getElementById('examPreview');
        const details = document.getElementById('examDetails');
        
        if (examId) {
            // Show preview with selected exam
            const selectedOption = this.options[this.selectedIndex];
            details.innerHTML = `
                <div>üìã <strong>Exam ID:</strong> ${examId}</div>
                <div style="margin-top: 5px;">‚úÖ Student submissions will be saved to this exam for valuation</div>
            `;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    });

    // Load exams when page loads
    window.addEventListener('DOMContentLoaded', loadAvailableExams);
        </script>
</body>
</html>