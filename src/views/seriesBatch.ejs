<%- include('partials/head', { pageTitle: 'Batch Evaluation' }) %>

<%- include('partials/navbar', { user: user, activePage: 'upload' }) %>

<main class="page-content">
    <div class="container">

        <h1 class="page-heading">ğŸ‘¨â€ğŸ« Series Exam Bundle Valuation</h1>

        <!-- Exam General Details -->
        <div class="panel">
            <h3>ğŸ“ Exam General Details</h3>
            <div class="flex-row">
                <div>
                    <label class="form-group" style="display:block; font-size:0.875rem; font-weight:600; margin-bottom:0.4rem;">Batch Class</label>
                    <input type="text" id="globalClass" class="input-box" placeholder="e.g. S8" value="S8">
                </div>
                <div>
                    <label style="display:block; font-size:0.875rem; font-weight:600; margin-bottom:0.4rem;">Subject</label>
                    <input type="text" id="globalSubject" class="input-box" placeholder="e.g. AI" value="AI">
                </div>
            </div>
        </div>

        <!-- Answer Key Selector -->
        <div class="panel panel--green">
            <h3>ğŸ¯ Select Answer Key</h3>
            <p style="font-size:0.875rem; color:var(--color-text-2); margin-bottom:1rem;">
                Choose which exam's answer key to use for this batch.
            </p>

            <!-- Selector row -->
            <div id="examSelectorContainer" class="exam-selector-row">
                <div>
                    <label>Select Exam:</label>
                    <select id="examIdSelect" class="input-box">
                        <option value="">-- Select an exam --</option>
                    </select>
                </div>
                <button type="button" class="btn btn-secondary" onclick="goToCreateAnswerKey()">
                    â• Create New
                </button>
            </div>

            <!-- Selected exam preview -->
            <div id="examPreview" class="exam-preview">
                <strong>Selected Exam:</strong>
                <div id="examDetails" style="margin-top:0.4rem;"></div>
            </div>

            <!-- No exams warning -->
            <div id="noExamsWarning" class="no-exams-warning">
                <div class="no-exams-warning__inner">
                    <div class="no-exams-warning__icon">âš ï¸</div>
                    <div>
                        <h4>No Answer Keys Found!</h4>
                        <p>Before uploading student papers, you need to create an answer key first.</p>
                        <div class="no-exams-warning__btn-group">
                            <button class="btn btn-secondary" onclick="goToCreateAnswerKey()">
                                ğŸ”‘ Create Answer Key Now â†’
                            </button>
                            <button class="btn btn-ghost" onclick="window.location.reload()">
                                ğŸ”„ Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Cards -->
        <div id="studentContainer"></div>

        <!-- Action Bar -->
        <div class="batch-actions">
            <button type="button" class="btn btn-add-student" onclick="addStudentBlock()">
                â• Add Student
            </button>
            <button type="button" id="submitBatchButton" class="btn btn-batch-submit" onclick="submitBatchEvaluation()">
                ğŸš€ Start Batch Valuation
            </button>
        </div>

        <!-- Loading Bar -->
        <div id="loadingMessage" class="loading-bar">
            <div class="spinner"></div>
            <p>Processing Bundle... Please stay on this page.</p>
        </div>

    </div>
</main>

<!-- Hidden file input -->
<input type="file" id="globalFileInput" accept="image/*" multiple style="display:none;">

<%- include('partials/footer') %>

<script>
    let studentData = [];
    let currentTargetStudentId = null;
    const globalFileInput = document.getElementById('globalFileInput');

    // ---- Student block management ----

    function addStudentBlock() {
        const studentId = Date.now();
        studentData.push({ id: studentId, files: [], roll_no: '' });

        const container = document.getElementById('studentContainer');
        const card = document.createElement('div');
        card.id = 'card-' + studentId;
        card.className = 'student-card';

        card.innerHTML = `
            <div class="student-card__header">
                <div class="student-card__field">
                    <label>Student Roll No.</label>
                    <input type="text" class="input-box" placeholder="Enter Roll No"
                        oninput="updateRollNo(${studentId}, this.value)">
                </div>
                <div class="student-card__actions">
                    <button type="button" class="btn-add-pages" onclick="triggerFileInput(${studentId})">
                        ğŸ“„ Add Pages
                    </button>
                    <button type="button" class="btn-remove" onclick="removeStudent(${studentId})">
                        ğŸ—‘ Remove
                    </button>
                </div>
            </div>
            <div id="list-${studentId}" class="student-card__files"></div>
        `;

        container.appendChild(card);
        updateSubmitBtn();
    }

    function updateRollNo(id, val) {
        const s = studentData.find(s => s.id === id);
        if (s) s.roll_no = val;
    }

    function triggerFileInput(id) {
        currentTargetStudentId = id;
        globalFileInput.click();
    }

    globalFileInput.addEventListener('change', function (e) {
        const newFiles = Array.from(e.target.files);
        if (newFiles.length > 0 && currentTargetStudentId) {
            const student = studentData.find(s => s.id === currentTargetStudentId);
            student.files = student.files.concat(newFiles);
            renderFileList(currentTargetStudentId);
        }
        globalFileInput.value = '';
    });

    function renderFileList(id) {
        const student = studentData.find(s => s.id === id);
        const listDiv = document.getElementById('list-' + id);
        listDiv.innerHTML = student.files.map((f, i) =>
            `<span class="file-tag ${i === 0 ? 'file-tag--id' : ''}">
                ${i === 0 ? 'ğŸªª ID' : 'ğŸ“„ Pg ' + i} â€” ${f.name}
            </span>`
        ).join('');
        updateSubmitBtn();
    }

    function removeStudent(id) {
        studentData = studentData.filter(s => s.id !== id);
        document.getElementById('card-' + id).remove();
        updateSubmitBtn();
    }

    function updateSubmitBtn() {
        const btn = document.getElementById('submitBatchButton');
        btn.style.display = studentData.some(s => s.files.length > 0) ? 'inline-flex' : 'none';
    }

    // ---- Submission ----

    function submitBatchEvaluation() {
        document.getElementById('loadingMessage').style.display = 'flex';

        const formData = new FormData();
        formData.append('global_class',   document.getElementById('globalClass').value);
        formData.append('global_subject', document.getElementById('globalSubject').value);

        const examId = document.getElementById('examIdSelect').value;
        if (examId) formData.append('exam_id', examId);

        const activeStudents = studentData.filter(s => s.files.length > 0);
        formData.append('student_count', activeStudents.length);

        activeStudents.forEach((student, i) => {
            formData.append('roll_no_' + i, student.roll_no);
            student.files.forEach(file => formData.append('student_' + i, file));
        });

        fetch('/seriesBundleEvaluate', { method: 'POST', body: formData })
            .then(res => res.text())
            .then(html => { document.open(); document.write(html); document.close(); })
            .catch(err => {
                alert('Evaluation Failed: ' + err.message);
                document.getElementById('loadingMessage').style.display = 'none';
            });
    }

    // ---- Load available exams ----

    async function loadAvailableExams() {
        try {
            const response = await fetch('/api/list_answer_keys');
            const data = await response.json();

            const select          = document.getElementById('examIdSelect');
            const noExamsWarning  = document.getElementById('noExamsWarning');
            const examSelector    = document.getElementById('examSelectorContainer');
            const studentContainer= document.getElementById('studentContainer');
            const submitBtn       = document.getElementById('submitBatchButton');

            if (data.status === 'Success' && data.answer_keys.length > 0) {
                data.answer_keys.forEach(exam => {
                    const opt = document.createElement('option');
                    opt.value = exam.exam_id;
                    opt.textContent = exam.exam_name + ' (' + exam.class + ' â€” ' + exam.subject + ')';
                    opt.dataset.examName = exam.exam_name;
                    opt.dataset.class    = exam.class;
                    opt.dataset.subject  = exam.subject;
                    select.appendChild(opt);
                });

                select.addEventListener('change', function () {
                    if (!this.value) {
                        document.getElementById('examPreview').style.display = 'none';
                        return;
                    }
                    const opt = this.options[this.selectedIndex];
                    document.getElementById('globalClass').value   = opt.dataset.class;
                    document.getElementById('globalSubject').value = opt.dataset.subject;

                    document.getElementById('examDetails').innerHTML =
                        '<div><strong>Exam:</strong> ' + opt.dataset.examName + '</div>' +
                        '<div><strong>Class:</strong> ' + opt.dataset.class + ' &nbsp;|&nbsp; <strong>Subject:</strong> ' + opt.dataset.subject + '</div>';

                    document.getElementById('examPreview').style.display = 'block';
                });

                noExamsWarning.style.display  = 'none';
                examSelector.style.display    = 'flex';

                // Auto-select if returning from answer key creation
                const latestExamId = sessionStorage.getItem('latest_exam_id');
                if (latestExamId && sessionStorage.getItem('return_to_series') === 'true') {
                    select.value = latestExamId;
                    select.dispatchEvent(new Event('change'));
                    sessionStorage.removeItem('return_to_series');
                    showToast('âœ… Answer key loaded! You can now upload student papers.');
                }

            } else {
                noExamsWarning.style.display  = 'block';
                examSelector.style.display    = 'none';
                studentContainer.style.display = 'none';
                if (submitBtn) submitBtn.style.display = 'none';
            }
        } catch (error) {
            console.error('Failed to load exams:', error);
        }
    }

    function goToCreateAnswerKey() {
        sessionStorage.setItem('return_to_series', 'true');
        const hasFiles = studentData.some(s => s.files.length > 0);
        if (hasFiles && !confirm('You have files ready to upload. Leaving will lose this data. Continue?')) return;
        window.location.href = '/answer-key-setup';
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'toastOut 0.3s ease forwards';
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    window.addEventListener('DOMContentLoaded', loadAvailableExams);
</script>
