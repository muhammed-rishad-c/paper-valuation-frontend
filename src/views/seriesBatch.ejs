<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Bundle Valuation - Series Exam</title>
    <style>
        .container { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
        .global-header {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #90caf9;
        }
        .flex-row { display: flex; gap: 15px; margin-top: 10px; }
        .input-box {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
        }
        .student-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            background: #fff;
        }
        label { font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üë®‚Äçüè´ Series Exam Bundle Valuation</h1>

        <div class="global-header">
            <h3>üìù Exam General Details</h3>
            <div class="flex-row">
                <div style="flex: 1;">
                    <label>Batch Class (e.g., S8):</label>
                    <input type="text" id="globalClass" class="input-box" placeholder="S8" value="S8">
                </div>
                <div style="flex: 1;">
                    <label>Subject (e.g., AI):</label>
                    <input type="text" id="globalSubject" class="input-box" placeholder="AI" value="AI">
                </div>
            </div>
        </div>

        <div id="studentContainer"></div>

        <div style="margin-top: 20px;">
            <button type="button" onclick="addStudentBlock()">‚ûï Add Student</button>
            <button type="button" id="submitBatchButton" onclick="submitBatchEvaluation()" style="display: none; background-color: #2e7d32; color: white; padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px;">üöÄ Start Batch Valuation</button>
        </div>

        <input type="file" id="globalFileInput" accept="image/*" multiple style="display: none;">

        <div id="loadingMessage" style="display: none; color: #1565c0; margin-top: 20px; font-weight: bold;">
            <p>Processing Bundle... Please stay on this page.</p>
        </div>
    </div>

    <script>
        let studentData = []; 
        let currentTargetStudentId = null;
        const globalFileInput = document.getElementById('globalFileInput');

        function addStudentBlock() {
            const studentId = Date.now();
            // We only need to store roll_no per student now
            studentData.push({ id: studentId, files: [], roll_no: "" });

            const container = document.getElementById('studentContainer');
            const card = document.createElement('div');
            card.id = `card-${studentId}`;
            card.className = "student-card";

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="width: 200px;">
                        <label>Student Roll No:</label>
                        <input type="text" class="input-box" placeholder="Enter Roll No" oninput="updateRollNo(${studentId}, this.value)">
                    </div>
                    <div>
                        <button type="button" onclick="triggerFileInput(${studentId})">üìÑ Add Pages</button>
                        <button type="button" onclick="removeStudent(${studentId})" style="color: #d32f2f; background: none; border: 1px solid #d32f2f; padding: 5px; cursor: pointer; border-radius: 3px;">Remove</button>
                    </div>
                </div>
                <div id="list-${studentId}" style="margin-top: 10px; font-size: 0.85em; color: #555;"></div>
            `;
            container.appendChild(card);
            updateSubmitBtn();
        }

        function updateRollNo(id, val) {
            const student = studentData.find(s => s.id === id);
            if (student) student.roll_no = val;
        }

        function triggerFileInput(id) {
            currentTargetStudentId = id;
            globalFileInput.click();
        }

        globalFileInput.addEventListener('change', function(e) {
            const newFiles = Array.from(e.target.files);
            if (newFiles.length > 0 && currentTargetStudentId) {
                const student = studentData.find(s => s.id === currentTargetStudentId);
                student.files = student.files.concat(newFiles);
                renderFileList(currentTargetStudentId);
            }
            globalFileInput.value = ''; 
        });

        function renderFileList(id) {
            const student = studentData.find(s => s.id === id);
            const listDiv = document.getElementById(`list-${id}`);
            listDiv.innerHTML = student.files.map((f, i) => 
                `<div>${i === 0 ? '<b>[ID]</b>' : '[Pg ' + i + ']'} ${f.name}</div>`
            ).join('');
            updateSubmitBtn();
        }

        function removeStudent(id) {
            studentData = studentData.filter(s => s.id !== id);
            document.getElementById(`card-${id}`).remove();
            updateSubmitBtn();
        }

        function updateSubmitBtn() {
            const btn = document.getElementById('submitBatchButton');
            btn.style.display = studentData.some(s => s.files.length > 0) ? 'inline-block' : 'none';
        }

        function submitBatchEvaluation() {
            document.getElementById('loadingMessage').style.display = 'block';
            const formData = new FormData();
            
            // Send Global Details once
            formData.append('global_class', document.getElementById('globalClass').value);
            formData.append('global_subject', document.getElementById('globalSubject').value);

            const activeStudents = studentData.filter(s => s.files.length > 0);
            formData.append('student_count', activeStudents.length);

            activeStudents.forEach((student, i) => {
                // Send manual roll_no for this specific student
                formData.append(`roll_no_${i}`, student.roll_no);
                
                student.files.forEach(file => {
                    formData.append(`student_${i}`, file);
                });
            });

            fetch('/seriesBundleEvaluate', { method: 'POST', body: formData })
            .then(res => res.text())
            .then(html => {
                document.open();
                document.write(html);
                document.close();
            })
            .catch(err => {
                alert('Evaluation Failed: ' + err.message);
                document.getElementById('loadingMessage').style.display = 'none';
            });
        }
    </script>
</body>
</html>