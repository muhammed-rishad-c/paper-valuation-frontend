<%- include('partials/head', { pageTitle: 'History' }) %>

<%- include('partials/navbar', { user: user, activePage: 'history' }) %>

<main class="page-content">
    <div class="container">

        <!-- Header -->
        <div class="history-header">
            <h1>üìä Evaluation History</h1>
            <p>View all your past exams and export results</p>

            <div class="filters">
                <select class="filter-select" id="examFilter" onchange="filterExams()">
                    <option value="">All Exams</option>
                </select>
                <select class="filter-select" id="statusFilter" onchange="filterExams()">
                    <option value="">All Status</option>
                    <option value="completed">Completed</option>
                    <option value="pending">Pending</option>
                </select>
                <select class="filter-select" id="sortFilter" onchange="filterExams()">
                    <option value="date_desc">Newest First</option>
                    <option value="date_asc">Oldest First</option>
                    <option value="name_asc">Name (A-Z)</option>
                    <option value="students_desc">Most Students</option>
                </select>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingIndicator" class="loading">
            Loading your exam history...
        </div>

        <!-- Exam list -->
        <div class="exam-list" id="examList" style="display:none;"></div>

    </div>
</main>

<%- include('partials/footer') %>

<script>
    let allExams = [];

    async function loadHistory() {
        try {
            const response = await fetch('/api/history');
            const data = await response.json();

            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('examList').style.display = 'grid';

            if (data.status === 'Success') {
                allExams = data.exams;
                populateFilters(allExams);
                displayExams(allExams);
            }
        } catch (error) {
            document.getElementById('loadingIndicator').innerHTML =
                '<div style="color:var(--red-500); text-align:center; padding:2rem;">Failed to load history. Please refresh the page.</div>';
        }
    }

    function displayExams(exams) {
        const list = document.getElementById('examList');

        if (!exams || exams.length === 0) {
            list.innerHTML = '<div class="no-data">üì≠ No exams found. Create your first exam to get started!</div>';
            return;
        }

        list.innerHTML = exams.map(exam => {
            const completionRate = exam.submissions_count > 0
                ? Math.round((exam.completed_count / exam.submissions_count) * 100)
                : 0;

            const pendingCount = exam.submissions_count - exam.completed_count;

            return `
                <div class="exam-card">
                    <div class="exam-card-header">
                        <div>
                            <div class="exam-title">${exam.exam_name}</div>
                            <div class="exam-meta">${exam.class} &nbsp;‚Ä¢&nbsp; ${exam.subject} &nbsp;‚Ä¢&nbsp; Total Marks: ${exam.total_marks}</div>
                            <div class="exam-meta">Created: ${new Date(exam.created_at).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' })}</div>
                            ${exam.completed_count > 0 ? `
                                <div class="status-badges">
                                    <span class="status-badge status-completed">‚úì ${exam.completed_count} Evaluated</span>
                                    ${pendingCount > 0 ? `<span class="status-badge status-pending">‚è≥ ${pendingCount} Pending</span>` : ''}
                                </div>` : ''}
                        </div>

                        <div class="exam-actions">
                            ${exam.submissions_count > 0 ? `
                                <a href="/valuation-prep/${exam.exam_id}" class="action-btn view">üìã View Details</a>
                                ${exam.completed_count > 0 ? `
                                    <button onclick="exportPDF('${exam.exam_id}')"   class="action-btn pdf">üìÑ PDF</button>
                                    <button onclick="exportExcel('${exam.exam_id}')" class="action-btn excel">üìä Excel</button>
                                ` : ''}
                            ` : `<span style="font-size:0.85rem; color:var(--color-muted);">No submissions yet</span>`}
                        </div>
                    </div>

                    <div class="exam-stats">
                        <div class="stat-box">
                            <div class="stat-value">${exam.submissions_count}</div>
                            <div class="stat-label">Students</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${exam.completed_count}</div>
                            <div class="stat-label">Evaluated</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${completionRate}%</div>
                            <div class="stat-label">Progress</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${exam.avg_percentage ? exam.avg_percentage.toFixed(1) + '%' : 'N/A'}</div>
                            <div class="stat-label">Avg Score</div>
                        </div>
                    </div>
                </div>`;
        }).join('');
    }

    function populateFilters(exams) {
        const examFilter = document.getElementById('examFilter');
        [...new Set(exams.map(e => e.exam_name))].forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            examFilter.appendChild(opt);
        });
    }

    function filterExams() {
        const examVal   = document.getElementById('examFilter').value;
        const statusVal = document.getElementById('statusFilter').value;
        const sortVal   = document.getElementById('sortFilter').value;

        let filtered = allExams.filter(exam => {
            const examMatch = !examVal || exam.exam_name === examVal;
            let statusMatch = true;
            if (statusVal === 'completed') statusMatch = exam.completed_count > 0;
            if (statusVal === 'pending')   statusMatch = exam.submissions_count > exam.completed_count;
            return examMatch && statusMatch;
        });

        filtered.sort((a, b) => {
            switch (sortVal) {
                case 'date_desc':     return new Date(b.created_at) - new Date(a.created_at);
                case 'date_asc':      return new Date(a.created_at) - new Date(b.created_at);
                case 'name_asc':      return a.exam_name.localeCompare(b.exam_name);
                case 'students_desc': return b.submissions_count - a.submissions_count;
                default:              return 0;
            }
        });

        displayExams(filtered);
    }

    async function exportPDF(examId) {
        showToast('Generating PDF...', 'info');
        try {
            const res = await fetch('/api/export/pdf/' + examId);
            if (!res.ok) throw new Error();
            downloadBlob(await res.blob(), 'exam_results_' + examId + '_' + Date.now() + '.pdf');
            showToast('‚úÖ PDF downloaded!', 'success');
        } catch { showToast('‚ùå Failed to export PDF', 'error'); }
    }

    async function exportExcel(examId) {
        showToast('Generating Excel...', 'info');
        try {
            const res = await fetch('/api/export/excel/' + examId);
            if (!res.ok) throw new Error();
            downloadBlob(await res.blob(), 'exam_results_' + examId + '_' + Date.now() + '.xlsx');
            showToast('‚úÖ Excel downloaded!', 'success');
        } catch { showToast('‚ùå Failed to export Excel', 'error'); }
    }

    function downloadBlob(blob, filename) {
        const url = window.URL.createObjectURL(blob);
        const a   = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    function showToast(message, type) {
        const existing = document.getElementById('exportStatus');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.id = 'exportStatus';
        toast.className = 'toast toast--' + (type || 'info');
        toast.textContent = message;
        document.body.appendChild(toast);

        if (type !== 'info') {
            setTimeout(() => toast.remove(), 3000);
        }
    }

    loadHistory();
</script>
