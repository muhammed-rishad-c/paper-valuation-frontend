<%- include('partials/head', { pageTitle: title || 'Batch Result' }) %>

<%- include('partials/navbar', { user: user, activePage: 'upload' }) %>

<main class="page-content">
    <div class="container">

        <!-- Header bar -->
        <div class="batch-result-header">
            <h1>üì¶ Batch Valuation Summary</h1>
            <div style="font-size:0.875rem; color:var(--color-text-2);">
                Total Students Processed: <strong style="color:var(--color-text);"><%= studentCount %></strong>
            </div>
        </div>

        <!-- Exam info banner -->
        <% if (examInfo && examInfo.exam_id) { %>
        <div class="exam-info-banner">
            <h3>‚úÖ Submissions Saved to Exam</h3>
            <p><strong>Exam ID:</strong> <%= examInfo.exam_id %></p>
            <p><strong>Students Successfully Saved:</strong> <%= examInfo.student_count %> / <%= studentCount %></p>
            <p style="opacity:0.85; font-size:0.825rem; margin-top:0.5rem;">
                All student submissions have been stored with the exam's answer key.
                You can now proceed to the valuation interface to compare answers and run AI evaluation.
            </p>
            <a href="/valuation-prep/<%= examInfo.exam_id %>" class="valuation-btn">
                üìä Prepare Valuation for this Exam ‚Üí
            </a>
        </div>
        <% } %>

        <!-- Student blocks -->
        <% result.forEach((studentResult, index) => { %>
        <div class="student-block">

            <div class="student-header">
                <span><strong>Student #<%= index + 1 %></strong></span>
                <% if (studentResult.status === 'Success') { %>
                    <span style="color:#15803d; font-weight:600;">‚úÖ Processed</span>
                <% } else { %>
                    <span style="color:var(--red-500); font-weight:600;">‚ùå Failed</span>
                <% } %>
            </div>

            <% if (studentResult.status === 'Success') { %>
                <div class="info-grid">
                    <div class="info-item"><strong>Name:</strong> <%= studentResult.student_info.name %></div>
                    <div class="info-item"><strong>Roll No:</strong> <%= studentResult.student_info.roll_no %></div>
                    <div class="info-item"><strong>Class:</strong> <%= studentResult.student_info.class %></div>
                    <div class="info-item"><strong>Subject:</strong> <%= studentResult.student_info.subject %></div>
                </div>

                <% if (studentResult.saved_to_exam) { %>
                    <div class="save-status saved">‚úÖ Saved to Exam: <%= studentResult.saved_to_exam %></div>
                <% } else { %>
                    <div class="save-status not-saved">‚ö†Ô∏è Not saved to exam storage (no exam_id provided)</div>
                <% } %>

                <h4>Recognized Answers:</h4>
                <pre><%= JSON.stringify(studentResult.recognition_result.answers, null, 2) %></pre>

                <details>
                    <summary>View Full JSON Structure</summary>
                    <pre><%= JSON.stringify(studentResult, null, 2) %></pre>
                </details>

            <% } else { %>
                <p class="error-msg">Error: <%= studentResult.error %></p>
                <details>
                    <summary>View Error JSON</summary>
                    <pre><%= JSON.stringify(studentResult, null, 2) %></pre>
                </details>
            <% } %>

        </div>
        <% }); %>

        <a href="/" class="back-link">‚Üê Return to Dashboard</a>

    </div>
</main>

<%- include('partials/footer') %>
