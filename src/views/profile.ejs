<%- include('partials/head', { pageTitle: 'Profile' }) %>

<%- include('partials/navbar', { user: user, activePage: 'profile' }) %>

<main class="page-content">
    <div class="container" style="max-width: 700px;">

        <!-- Profile card -->
        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-avatar">
                    <%= ((user.full_name || user.username || 'U').charAt(0).toUpperCase()) %>
                </div>
                <div class="profile-name">
                    <%= user.full_name || user.username || 'Unknown User' %>
                </div>
                <div class="profile-role">
                    <%= user.role === 'admin' ? 'üëë Administrator' : 'üë®‚Äçüè´ Teacher' %>
                </div>
            </div>

            <div class="profile-info">
                <div class="info-row">
                    <div class="info-label">Username</div>
                    <div class="info-value"><%= user.username %></div>
                </div>
                <div class="info-row">
                    <div class="info-label">Email</div>
                    <div class="info-value"><%= user.email %></div>
                </div>
                <div class="info-row">
                    <div class="info-label">Full Name</div>
                    <div class="info-value"><%= user.full_name || 'Not set' %></div>
                </div>
                <div class="info-row">
                    <div class="info-label">Member Since</div>
                    <div class="info-value"><%= user.created_at_formatted %></div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="action-section">
            <h2>Account Actions</h2>
            <button onclick="showEditModal()" class="btn btn-primary">‚úèÔ∏è Edit Profile</button>
            <button onclick="showPasswordModal()" class="btn btn-secondary">üîí Change Password</button>
        </div>

    </div>
</main>

<!-- Edit Profile Modal -->
<div id="editModal" class="modal-overlay">
    <div class="modal">
        <h3>‚úèÔ∏è Edit Profile</h3>

        <div id="editError"   class="modal-error"></div>
        <div id="editSuccess" class="modal-success"></div>

        <form id="editProfileForm">
            <div class="form-group">
                <label for="editFullName">Full Name</label>
                <input type="text" id="editFullName" value="<%= user.full_name || '' %>" required>
            </div>
            <div class="form-group">
                <label for="editEmail">Email Address</label>
                <input type="email" id="editEmail" value="<%= user.email || '' %>" required>
            </div>

            <div class="modal-buttons">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-cancel" onclick="hideEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Change Password Modal -->
<div id="passwordModal" class="modal-overlay">
    <div class="modal">
        <h3>üîí Change Password</h3>

        <div id="passwordError"   class="modal-error"></div>
        <div id="passwordSuccess" class="modal-success"></div>

        <form id="changePasswordForm">
            <div class="form-group">
                <label for="currentPassword">Current Password</label>
                <input type="password" id="currentPassword" required>
            </div>
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" required minlength="6">
                <small>Minimum 6 characters</small>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" id="confirmPassword" required minlength="6">
            </div>

            <div class="modal-buttons">
                <button type="submit" class="btn btn-primary">Save Password</button>
                <button type="button" class="btn btn-cancel" onclick="hidePasswordModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<%- include('partials/footer') %>

<script>
    // ---- Edit modal ----
    function showEditModal() {
        document.getElementById('editModal').classList.add('is-open');
    }

    function hideEditModal() {
        document.getElementById('editModal').classList.remove('is-open');
        document.getElementById('editError').style.display   = 'none';
        document.getElementById('editSuccess').style.display = 'none';
    }

    document.getElementById('editProfileForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const errorDiv   = document.getElementById('editError');
        const successDiv = document.getElementById('editSuccess');
        errorDiv.style.display   = 'none';
        successDiv.style.display = 'none';

        try {
            const res  = await fetch('/api/update-profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    full_name: document.getElementById('editFullName').value,
                    email:     document.getElementById('editEmail').value
                })
            });
            const data = await res.json();

            if (data.status === 'Success') {
                successDiv.textContent = '‚úÖ Profile updated successfully!';
                successDiv.style.display = 'block';
                setTimeout(() => window.location.reload(), 1500);
            } else {
                errorDiv.textContent = data.error || 'Failed to update profile.';
                errorDiv.style.display = 'block';
            }
        } catch {
            errorDiv.textContent = 'Network error. Please try again.';
            errorDiv.style.display = 'block';
        }
    });

    // ---- Password modal ----
    function showPasswordModal() {
        document.getElementById('passwordModal').classList.add('is-open');
    }

    function hidePasswordModal() {
        document.getElementById('passwordModal').classList.remove('is-open');
        document.getElementById('changePasswordForm').reset();
        document.getElementById('passwordError').style.display   = 'none';
        document.getElementById('passwordSuccess').style.display = 'none';
    }

    document.getElementById('changePasswordForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const errorDiv   = document.getElementById('passwordError');
        const successDiv = document.getElementById('passwordSuccess');
        errorDiv.style.display   = 'none';
        successDiv.style.display = 'none';

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword     = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            errorDiv.textContent = '‚ùå New passwords do not match!';
            errorDiv.style.display = 'block';
            return;
        }

        if (newPassword.length < 6) {
            errorDiv.textContent = '‚ùå Password must be at least 6 characters!';
            errorDiv.style.display = 'block';
            return;
        }

        try {
            const res  = await fetch('/api/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentPassword, newPassword })
            });
            const data = await res.json();

            if (data.status === 'Success') {
                successDiv.textContent = '‚úÖ Password changed successfully!';
                successDiv.style.display = 'block';
                setTimeout(() => hidePasswordModal(), 2000);
            } else {
                errorDiv.textContent = data.error || 'Failed to change password.';
                errorDiv.style.display = 'block';
            }
        } catch {
            errorDiv.textContent = 'Network error. Please try again.';
            errorDiv.style.display = 'block';
        }
    });

    // Close modals on backdrop click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function (e) {
            if (e.target === this) {
                this.classList.remove('is-open');
            }
        });
    });

    // Close on ESC
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay.is-open').forEach(m => m.classList.remove('is-open'));
        }
    });
</script>
