<!DOCTYPE html>
<html>

<head>
    <title><%= title %></title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .exam-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .exam-header h1 {
            margin: 0 0 10px 0;
        }

        .exam-header p {
            margin: 5px 0;
            opacity: 0.95;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .export-btn {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .export-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .export-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .valuation-btn {
            background: #FF5722;
        }

        .valuation-btn:hover {
            background: #f4511e;
        }

        #valuationProgress {
            display: none;
            margin: 20px 0;
            padding: 25px;
            background: white;
            border-radius: 8px;
            border: 2px solid #ff9800;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #valuationProgress h3 {
            margin: 0 0 10px 0;
            color: #e65100;
        }

        #progressText {
            color: #666;
            margin-bottom: 15px;
        }

        .progress-bar-container {
            width: 100%;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            height: 35px;
            position: relative;
        }

        #progressBar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            min-width: 50px;
        }

        #valuationResults {
            display: none;
            margin: 20px 0;
        }

        .student-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            background: white;
        }

        .question-compare {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 10px 0;
        }

        .teacher-answer {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }

        .student-answer {
            background: #fff3e0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ff9800;
        }

        .error-alert {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #f44336;
            margin: 20px 0;
        }

        .success-alert {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #4caf50;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="exam-header">
        <h1><%= examData.exam_metadata.exam_name %></h1>
        <p>üìö Class: <%= examData.exam_metadata.class %> | Subject: <%= examData.exam_metadata.subject %></p>
        <p>üíØ Total Marks: <%= examData.exam_metadata.total_marks %></p>
        <p>üë• Students Submitted: <%= examData.students.length %></p>
    </div>

    <div class="button-group">
        <button class="export-btn" onclick="exportValuationJSON()">
            üì• Export Complete Valuation Data (JSON)
        </button>

        <button class="export-btn valuation-btn" id="startValuationBtn" onclick="startValuation()">
            üéØ Start AI Valuation for All Students
        </button>
    </div>

    <!-- Progress indicator -->
    <div id="valuationProgress">
        <h3>‚è≥ Valuation in Progress...</h3>
        <p id="progressText">Initializing AI evaluation system...</p>
        <div class="progress-bar-container">
            <div id="progressBar" style="width: 10%;">
                Processing...
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div id="errorContainer"></div>

    <!-- Results container -->
    <div id="valuationResults">
        <!-- Results will be dynamically inserted here -->
    </div>

    <h2>üìù Student Submissions</h2>

    <% examData.students.forEach((student, idx) => { %>
        <div class="student-card">
            <h3>Student <%= idx + 1 %>: <%= student.name %> (Roll: <%= student.roll_no %>)</h3>
            <p><strong>Status:</strong> <%= student.valuation_status %></p>

            <h4>Question-by-Question Comparison</h4>

            <% Object.keys(examData.teacher_answers).forEach(qNum => { %>
                <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                    <h5>Question <%= qNum %> (<%= examData.question_types[qNum] %> answer, <%= examData.question_marks[qNum] %> marks)</h5>

                    <div class="question-compare">
                        <div class="teacher-answer">
                            <strong>‚úÖ Teacher's Answer:</strong>
                            <p><%= examData.teacher_answers[qNum] %></p>
                        </div>

                        <div class="student-answer">
                            <strong>üìù Student's Answer:</strong>
                            <p><%= student.answers[qNum] || '(No answer provided)' %></p>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>
    <% }) %>

    <script>
        // ============================================
        // DATA INITIALIZATION
        // ============================================
        const valuationData = <%- JSON.stringify(examData) %>;
        const examId = valuationData.exam_metadata.exam_id;
        
        console.log('üìä Initialized valuation page for exam:', examId);
        console.log('üë• Total students:', valuationData.students.length);

        // ============================================
        // EXPORT FUNCTIONALITY
        // ============================================
        function exportValuationJSON() {
            try {
                const dataStr = JSON.stringify(valuationData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `valuation_${examId}_${Date.now()}.json`;
                link.click();

                URL.revokeObjectURL(url);
                showAlert('success', '‚úÖ Valuation data exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                showAlert('error', '‚ùå Failed to export data: ' + error.message);
            }
        }

        // ============================================
        // VALUATION PROCESS
        // ============================================
        async function startValuation() {
            console.log('üéØ Starting valuation for exam:', examId);

            const progressDiv = document.getElementById('valuationProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const resultsDiv = document.getElementById('valuationResults');
            const startBtn = document.getElementById('startValuationBtn');

            if (!progressDiv || !progressBar || !progressText) {
                showAlert('error', '‚ùå Error: Required elements not found on page!');
                return;
            }

            // Disable button and show progress
            startBtn.disabled = true;
            startBtn.textContent = '‚è≥ Processing...';
            progressDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            clearErrors();

            try {
                // Update progress
                updateProgress(20, 'Sending request to AI evaluation system...');

                console.log('üì° Calling API: /api/evaluate_exam/' + examId);

                const response = await fetch(`/api/evaluate_exam/${examId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì® Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error (${response.status}): ${errorText}`);
                }

                updateProgress(60, 'AI is analyzing student answers...');

                const result = await response.json();
                console.log('‚úÖ Received result:', result);

                if (result.status === 'Success') {
                    updateProgress(100, 'Valuation completed! Preparing results...');
                    
                    setTimeout(() => {
                        displayValuationResults(result);
                        progressDiv.style.display = 'none';
                        startBtn.disabled = false;
                        startBtn.textContent = 'üéØ Start AI Valuation for All Students';
                    }, 500);
                } else {
                    throw new Error(result.error || 'Valuation failed');
                }

            } catch (error) {
                console.error('üí• Valuation error:', error);
                progressDiv.style.display = 'none';
                startBtn.disabled = false;
                startBtn.textContent = 'üéØ Start AI Valuation for All Students';
                
                showAlert('error', `‚ùå Valuation Failed: ${error.message}`);
            }
        }

        function updateProgress(percentage, message) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
                progressBar.textContent = percentage + '%';
            }
            
            if (progressText) {
                progressText.textContent = message;
            }
        }

        // ============================================
        // RESULTS DISPLAY
        // ============================================
        function displayValuationResults(data) {
            console.log('üìä Displaying results for', data.total_students, 'students');

            const resultsDiv = document.getElementById('valuationResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = buildResultsHTML(data);
            
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            showAlert('success', '‚úÖ AI Valuation completed successfully!');
        }

        function buildResultsHTML(data) {
            const html = [];

            // Summary header
            html.push(`
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 15px 0;">‚úÖ AI Valuation Complete!</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.9em; opacity: 0.9;">Total Students</div>
                            <div style="font-size: 2em; font-weight: bold;">${data.total_students}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.9em; opacity: 0.9;">Successfully Evaluated</div>
                            <div style="font-size: 2em; font-weight: bold; color: #c8e6c9;">${data.evaluated_successfully}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.9em; opacity: 0.9;">Failed</div>
                            <div style="font-size: 2em; font-weight: bold; color: #ffcdd2;">${data.evaluation_failed}</div>
                        </div>
                    </div>
                </div>
            `);

            html.push('<h2 style="margin-bottom: 20px;">üìä Individual Student Results</h2>');

            // Sort by marks
            const sortedResults = [...data.results].sort((a, b) => {
                if (a.status === 'Success' && b.status === 'Success') {
                    return b.total_marks_obtained - a.total_marks_obtained;
                }
                return 0;
            });

            // Build student cards
            sortedResults.forEach((student, idx) => {
                if (student.status === 'Success') {
                    html.push(buildStudentSuccessCard(student, idx));
                } else {
                    html.push(buildStudentErrorCard(student));
                }
            });

            return html.join('');
        }

        function buildStudentSuccessCard(student, idx) {
            const percentage = student.percentage;
            const resultColor = student.result === 'Pass' ? '#4CAF50' : '#f44336';
            const rankBadges = ['ü•á', 'ü•à', 'ü•â'];
            const rankBadge = idx < 3 ? rankBadges[idx] : '#' + (idx + 1);

            return `
                <div style="border: 2px solid #e0e0e0; padding: 20px; margin: 15px 0; border-radius: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">
                            <span style="font-size: 1.5em; margin-right: 10px;">${rankBadge}</span>
                            ${student.student_name}
                            <span style="color: #666; font-size: 0.8em;">(Roll: ${student.roll_no})</span>
                        </h3>
                        <div style="background: ${resultColor}; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 1.1em;">
                            ${student.result}
                        </div>
                    </div>

                    ${buildStatsGrid(student)}
                    ${buildQuestionBreakdown(student)}
                </div>
            `;
        }

        function buildStatsGrid(student) {
            return `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 15px 0;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="color: #1976d2; font-size: 0.9em; margin-bottom: 5px;">Marks Obtained</div>
                        <div style="font-size: 2em; font-weight: bold; color: #1565c0;">${student.total_marks_obtained}</div>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="color: #7b1fa2; font-size: 0.9em; margin-bottom: 5px;">Total Marks</div>
                        <div style="font-size: 2em; font-weight: bold;">${student.total_marks_possible}</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="color: #f57c00; font-size: 0.9em; margin-bottom: 5px;">Percentage</div>
                        <div style="font-size: 2em; font-weight: bold; color: #ef6c00;">${student.percentage}%</div>
                    </div>
                </div>
            `;
        }

        function buildQuestionBreakdown(student) {
            const questionsHTML = [];
            
            // Group questions by OR groups
            const { orGroupQuestions, regularQuestions } = groupQuestions(student.marks_breakdown);

            // Regular questions
            Object.entries(regularQuestions).forEach(([qLabel, q]) => {
                questionsHTML.push(buildRegularQuestion(qLabel, q));
            });

            // OR group questions
            Object.entries(orGroupQuestions).forEach(([groupKey, group]) => {
                questionsHTML.push(buildOrGroupQuestion(group));
            });

            return `
                <details style="margin-top: 15px;">
                    <summary style="cursor: pointer; color: #1976d2; font-weight: bold; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        üìã View Question-wise Breakdown
                    </summary>
                    <div style="margin-top: 15px; padding: 15px; background: #fafafa; border-radius: 8px;">
                        ${questionsHTML.join('')}
                    </div>
                </details>
            `;
        }

        function groupQuestions(marksBreakdown) {
            const orGroupQuestions = {};
            const regularQuestions = {};

            Object.entries(marksBreakdown).forEach(([qLabel, q]) => {
                if (q.or_group) {
                    const groupKey = q.or_type === 'single' 
                        ? `single_${q.or_options.join('_')}`
                        : `pair_${q.or_pair_a.join('')}_${q.or_pair_b.join('')}`;

                    if (!orGroupQuestions[groupKey]) {
                        orGroupQuestions[groupKey] = {
                            type: q.or_type,
                            questions: [],
                            ...q
                        };
                    }
                    orGroupQuestions[groupKey].questions.push({ label: qLabel, data: q });
                } else {
                    regularQuestions[qLabel] = q;
                }
            });

            return { orGroupQuestions, regularQuestions };
        }

        function buildRegularQuestion(qLabel, q) {
            const scorePercentage = (q.marks_obtained / q.max_marks) * 100;
            const barColor = scorePercentage >= 70 ? '#4CAF50' : scorePercentage >= 40 ? '#FF9800' : '#f44336';

            return `
                <div style="padding: 12px; margin: 8px 0; background: white; border-radius: 6px; border-left: 4px solid ${barColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 1.1em;">${qLabel}</strong>
                            <span style="color: #666; margin-left: 10px;">(${q.question_type} answer)</span>
                        </div>
                        <div style="font-size: 1.2em; font-weight: bold;">
                            <span style="color: ${barColor};">${q.marks_obtained}</span> / ${q.max_marks}
                        </div>
                    </div>
                    <div style="width: 100%; background: #e0e0e0; height: 8px; border-radius: 4px; margin-top: 8px; overflow: hidden;">
                        <div style="width: ${scorePercentage}%; background: ${barColor}; height: 100%;"></div>
                    </div>
                </div>
            `;
        }

        function buildOrGroupQuestion(group) {
            if (group.type === 'single') {
                const q = group.questions[0];
                const scorePercentage = (q.data.marks_obtained / q.data.max_marks) * 100;
                const barColor = scorePercentage >= 70 ? '#4CAF50' : scorePercentage >= 40 ? '#FF9800' : '#f44336';

                return `
                    <div style="padding: 12px; margin: 8px 0; background: #fff3e0; border-radius: 6px; border: 2px solid #ff9800;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <strong style="font-size: 1.1em; color: #e65100;">‚ö° ${q.label}</strong>
                                <span style="color: #666; margin-left: 10px;">(${q.data.question_type} answer)</span>
                                <div style="font-size: 0.85em; color: #e65100; margin-top: 4px;">
                                    OR Question: Q${group.or_options[0]} OR Q${group.or_options[1]} ‚Üí <strong>Chose Q${group.chosen_option}</strong>
                                </div>
                            </div>
                            <div style="font-size: 1.2em; font-weight: bold;">
                                <span style="color: ${barColor};">${q.data.marks_obtained}</span> / ${q.data.max_marks}
                            </div>
                        </div>
                        <div style="width: 100%; background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${scorePercentage}%; background: ${barColor}; height: 100%;"></div>
                        </div>
                    </div>
                `;
            } else {
                // Pair OR question (similar structure)
                return buildOrGroupPair(group);
            }
        }

        function buildOrGroupPair(group) {
            let totalScore = 0;
            let totalMax = 0;

            group.questions.forEach(q => {
                totalScore += q.data.marks_obtained;
                totalMax += q.data.max_marks;
            });

            const scorePercentage = (totalScore / totalMax) * 100;
            const barColor = scorePercentage >= 70 ? '#4CAF50' : scorePercentage >= 40 ? '#FF9800' : '#f44336';
            const chosenPair = group.chosen_pair === 'a' ? group.or_pair_a : group.or_pair_b;

            const pairQuestionsHTML = group.questions.map(q => {
                const qScorePercentage = (q.data.marks_obtained / q.data.max_marks) * 100;
                const qBarColor = qScorePercentage >= 70 ? '#4CAF50' : qScorePercentage >= 40 ? '#FF9800' : '#f44336';

                return `
                    <div style="padding: 8px; margin: 6px 0; background: white; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${q.label}</strong>
                            <span style="font-weight: bold;">
                                <span style="color: ${qBarColor};">${q.data.marks_obtained}</span> / ${q.data.max_marks}
                            </span>
                        </div>
                        <div style="width: 100%; background: #e0e0e0; height: 6px; border-radius: 3px; margin-top: 6px; overflow: hidden;">
                            <div style="width: ${qScorePercentage}%; background: ${qBarColor}; height: 100%;"></div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div style="padding: 12px; margin: 8px 0; background: #e8f5e9; border-radius: 6px; border: 2px solid #4caf50;">
                    <div style="margin-bottom: 8px;">
                        <strong style="font-size: 1.1em; color: #2e7d32;">‚ö° OR Question Pair</strong>
                        <div style="font-size: 0.85em; color: #2e7d32; margin-top: 4px;">
                            Q${group.or_pair_a.join(',')} OR Q${group.or_pair_b.join(',')} ‚Üí <strong>Chose Q${chosenPair.join(',')}</strong>
                        </div>
                    </div>
                    <div style="border-top: 1px solid #c8e6c9; padding-top: 10px; margin-top: 10px;">
                        ${pairQuestionsHTML}
                    </div>
                    <div style="border-top: 1px solid #c8e6c9; padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <strong>Pair Total:</strong>
                        <div style="font-size: 1.3em; font-weight: bold;">
                            <span style="color: ${barColor};">${totalScore}</span> / ${totalMax}
                        </div>
                    </div>
                    <div style="width: 100%; background: #e0e0e0; height: 10px; border-radius: 5px; margin-top: 8px; overflow: hidden;">
                        <div style="width: ${scorePercentage}%; background: ${barColor}; height: 100%;"></div>
                    </div>
                </div>
            `;
        }

        function buildStudentErrorCard(student) {
            return `
                <div style="border: 2px solid #ffcdd2; padding: 20px; margin: 15px 0; border-radius: 12px; background: #ffebee;">
                    <h4 style="color: #c62828; margin: 0;">‚ùå Roll No: ${student.roll_no} - Evaluation Failed</h4>
                    <p style="color: #666; margin: 10px 0 0 0;">Error: ${student.error}</p>
                </div>
            `;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showAlert(type, message) {
            const container = document.getElementById('errorContainer');
            const alertClass = type === 'success' ? 'success-alert' : 'error-alert';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = alertClass;
            alertDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function clearErrors() {
            const container = document.getElementById('errorContainer');
            if (container) {
                container.innerHTML = '';
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        console.log('‚úÖ Valuation prep page loaded successfully');
    </script>
</body>

</html>
