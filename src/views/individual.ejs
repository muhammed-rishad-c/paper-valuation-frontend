<%- include('partials/head', { pageTitle: 'Individual Evaluation' }) %>

<%- include('partials/navbar', { user: user, activePage: 'upload' }) %>

<main class="page-content">
    <div class="container">

        <!-- Page header -->
        <div class="header">
            <div>
                <h1>ğŸ“„ Individual Paper Evaluation</h1>
                <p>Upload student answer sheets for AI-powered evaluation</p>
            </div>
            <a href="/" class="btn btn-secondary">â† Dashboard</a>
        </div>

        <!-- Warning -->
        <div class="warning-banner">
            âš ï¸ <strong>Important:</strong> Add pages in the correct order (Page 1 â†’ Page 2 â†’ Page 3â€¦).
            Use the â†‘â†“ arrows to reorder if needed.
        </div>

        <!-- Answer Key Selector -->
        <div class="panel panel--green">
            <h3>ğŸ¯ Select Answer Key</h3>
            <p style="font-size:0.875rem; color:var(--color-text-2); margin-bottom:1rem;">
                Choose which exam's answer key to use for evaluation.
            </p>

            <div id="examSelectorContainer" class="exam-selector-row">
                <div>
                    <label>Select Exam:</label>
                    <select id="examIdSelect" class="input-box">
                        <option value="">-- Select an exam --</option>
                    </select>
                </div>
                <button type="button" class="btn btn-secondary" onclick="goToCreateAnswerKey()">
                    â• Create New
                </button>
            </div>

            <div id="examPreview" class="exam-preview">
                <strong>Selected Exam:</strong>
                <div id="examDetails" style="margin-top:0.4rem;"></div>
            </div>

            <div id="noExamsWarning" class="no-exams-warning">
                <div class="no-exams-warning__inner">
                    <div class="no-exams-warning__icon">âš ï¸</div>
                    <div>
                        <h4>No Answer Keys Found!</h4>
                        <p>Before evaluating papers, you need to create an answer key first.</p>
                        <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                            <button class="btn btn-secondary" onclick="goToCreateAnswerKey()">ğŸ”‘ Create Answer Key â†’</button>
                            <button class="btn btn-cancel" onclick="window.location.reload()">ğŸ”„ Refresh</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload panel -->
        <div class="section">

            <!-- File controls -->
            <div class="file-controls">
                <button type="button" id="addPagesButton" class="btn btn-primary">ğŸ“„ Add Pages</button>
                <button type="button" class="btn btn-danger-outline" onclick="clearAll()">ğŸ—‘ï¸ Clear All</button>
            </div>

            <!-- Hidden file input -->
            <input type="file" id="hiddenFileInput" accept="image/jpeg,image/png" multiple style="display:none;">

            <!-- File list -->
            <div id="fileList" class="file-list"></div>

            <!-- Empty state -->
            <div id="emptyState" class="empty-state">
                ğŸ“‚ No pages added yet. Click "Add Pages" to start.
            </div>

            <!-- Submit button -->
            <button type="button" id="submitButton" onclick="submitEvaluation()" style="display:none; margin-top:1rem;">
                ğŸš€ Start Valuation
            </button>

            <!-- Loading bar -->
            <div id="loadingMessage" class="loading-bar" style="margin-top:1rem;">
                <div class="spinner"></div>
                <div>
                    <p style="margin:0; font-weight:600; color:var(--color-primary);">Processing paper...</p>
                    <p style="margin:0; font-size:0.8rem; color:var(--color-muted);">This may take a moment for multiple pages.</p>
                </div>
            </div>

            <!-- How-to note -->
            <div class="note">
                <strong>How to use:</strong>
                <ol>
                    <li>Select an exam answer key above</li>
                    <li>Click "Add Pages" and select one or more images</li>
                    <li>Repeat to add more pages â€” they'll be appended in order</li>
                    <li>Use â†‘â†“ arrows to reorder pages if needed</li>
                    <li>Click "Start Valuation" when ready</li>
                </ol>
                <strong>Note:</strong> Ensure question numbers (Q1, Q2, etc.) are clearly marked on the <strong>left side</strong> of the paper.
            </div>

        </div>
    </div>
</main>

<%- include('partials/footer') %>

<script>
    const fileInput    = document.getElementById('hiddenFileInput');
    const fileListDiv  = document.getElementById('fileList');
    const submitButton = document.getElementById('submitButton');
    const addPagesBtn  = document.getElementById('addPagesButton');
    const emptyState   = document.getElementById('emptyState');

    let orderedFiles = [];

    addPagesBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', function (e) {
        const newFiles = Array.from(e.target.files);
        if (newFiles.length > 0) {
            orderedFiles = orderedFiles.concat(newFiles);
            renderFileList();
        }
        fileInput.value = '';
    });

    function renderFileList() {
        if (orderedFiles.length === 0) {
            fileListDiv.innerHTML = '';
            submitButton.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        fileListDiv.innerHTML = orderedFiles.map((file, i) => `
            <div class="file-item">
                <span class="page-number">Page ${i + 1}</span>
                <span>${file.name}</span>
                <div class="reorder-buttons">
                    <button type="button" onclick="moveUp(${i})"   ${i === 0 ? 'disabled' : ''}>â†‘</button>
                    <button type="button" onclick="moveDown(${i})" ${i === orderedFiles.length - 1 ? 'disabled' : ''}>â†“</button>
                </div>
                <button type="button" onclick="removeFile(${i})">Remove</button>
            </div>`).join('');

        submitButton.style.display = 'block';
    }

    function moveUp(i) {
        if (i > 0) { [orderedFiles[i], orderedFiles[i-1]] = [orderedFiles[i-1], orderedFiles[i]]; renderFileList(); }
    }

    function moveDown(i) {
        if (i < orderedFiles.length - 1) { [orderedFiles[i], orderedFiles[i+1]] = [orderedFiles[i+1], orderedFiles[i]]; renderFileList(); }
    }

    function removeFile(i) { orderedFiles.splice(i, 1); renderFileList(); }

    function clearAll() {
        if (orderedFiles.length > 0 && confirm('Clear all pages?')) { orderedFiles = []; renderFileList(); }
    }

    function submitEvaluation() {
        const examId = document.getElementById('examIdSelect').value;
        if (!examId) { alert('âš ï¸ Please select an exam first!'); document.getElementById('examIdSelect').focus(); return; }
        if (orderedFiles.length === 0) { alert('Please add at least one page.'); return; }

        const formData = new FormData();
        formData.append('exam_id', examId);
        orderedFiles.forEach(file => formData.append('paper_images', file));

        document.getElementById('loadingMessage').style.display = 'flex';
        submitButton.disabled = true;
        submitButton.textContent = 'â³ Processing...';
        addPagesBtn.disabled = true;
        document.getElementById('examIdSelect').disabled = true;

        fetch('/individualEvaluate', { method: 'POST', body: formData })
            .then(res => { if (!res.ok) throw new Error('Server error'); return res.text(); })
            .then(html => { document.open(); document.write(html); document.close(); })
            .catch(err => {
                alert('Error: ' + err.message);
                document.getElementById('loadingMessage').style.display = 'none';
                submitButton.disabled = false;
                submitButton.textContent = 'ğŸš€ Start Valuation';
                addPagesBtn.disabled = false;
                document.getElementById('examIdSelect').disabled = false;
            });
    }

    // ---- Load exams ----
    async function loadAvailableExams() {
        try {
            const res  = await fetch('/api/list_answer_keys');
            const data = await res.json();

            const select    = document.getElementById('examIdSelect');
            const noWarn    = document.getElementById('noExamsWarning');
            const selectorC = document.getElementById('examSelectorContainer');

            if (data.status === 'Success' && data.answer_keys.length > 0) {
                data.answer_keys.forEach(exam => {
                    const opt = document.createElement('option');
                    opt.value = exam.exam_id;
                    opt.textContent = exam.exam_name + ' (' + exam.class + ' â€” ' + exam.subject + ')';
                    opt.dataset.examName = exam.exam_name;
                    opt.dataset.class    = exam.class;
                    opt.dataset.subject  = exam.subject;
                    select.appendChild(opt);
                });

                select.addEventListener('change', function () {
                    const preview = document.getElementById('examPreview');
                    const details = document.getElementById('examDetails');
                    if (!this.value) { preview.style.display = 'none'; return; }
                    const opt = this.options[this.selectedIndex];
                    details.innerHTML =
                        '<div><strong>Exam:</strong> ' + opt.dataset.examName + '</div>' +
                        '<div><strong>Class:</strong> ' + opt.dataset.class + ' &nbsp;|&nbsp; <strong>Subject:</strong> ' + opt.dataset.subject + '</div>';
                    preview.style.display = 'block';
                });

                noWarn.style.display    = 'none';
                selectorC.style.display = 'flex';

                const latestId = sessionStorage.getItem('latest_exam_id');
                if (latestId && sessionStorage.getItem('return_to_individual') === 'true') {
                    select.value = latestId;
                    select.dispatchEvent(new Event('change'));
                    sessionStorage.removeItem('return_to_individual');
                    showToast('âœ… Answer key loaded! You can now upload papers for evaluation.');
                }

            } else {
                noWarn.style.display    = 'block';
                selectorC.style.display = 'none';
                select.disabled         = true;
                addPagesBtn.disabled    = true;
                submitButton.style.display = 'none';
            }
        } catch (e) { console.error('Failed to load exams:', e); }
    }

    function goToCreateAnswerKey() {
        sessionStorage.setItem('return_to_individual', 'true');
        if (orderedFiles.length > 0 &&
            !confirm('You have ' + orderedFiles.length + ' page(s) ready. Leaving will lose these files. Continue?')) return;
        window.location.href = '/answer-key-setup';
    }

    function showToast(message) {
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = message;
        document.body.appendChild(t);
        setTimeout(() => { t.style.animation = 'toastOut 0.3s ease forwards'; setTimeout(() => t.remove(), 300); }, 4000);
    }

    window.addEventListener('DOMContentLoaded', loadAvailableExams);
</script>
